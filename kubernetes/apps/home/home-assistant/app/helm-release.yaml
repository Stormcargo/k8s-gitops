---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: home-assistant
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.2.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    controllers:
      home-assistant:
        annotations:
          reloader.stakater.com/auto: "true"
        pod:
           annotations:
            k8s.v1.cni.cncf.io/networks: "hass-homekit-static"
        containers:
          app:
            image:
              repository: ghcr.io/onedr0p/home-assistant
              tag: 2024.4.3@sha256:71e02388dcd720e2f49538046f81bb1932e64e7680c73230fae1b2ace7400805
            envFrom:
              - secretRef:
                  name: home-assistant-env
            probes:
              liveness:
                enabled: false
              readiness:
                enabled: false
              startup:
                enabled: false
            resources:
              requests:
                cpu: 47m
                memory: 2Gi
              limits:
                memory: 2Gi

    service:
      app:
        controller: home-assistant
        ports:
          http:
            port: 8123

    ingress:
      app:
        enabled: true
        className: nginx
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
          hajimari.io/icon: "home-assistant"
        hosts:
          - host: &host "hass.${SECRET_DOMAIN}"
            paths:
              - path: /
                service:
                  identifier: app
                  port: http

    persistence:
      config:
        existingClaim: home-assistant-config-v1
        advancedMounts:
          home-assistant:
            app:
              - path: /config


#   values:
#     nodeSelector:
#       network-interface: enp2s0
#     image:
#       repository: ghcr.io/onedr0p/home-assistant
#       tag: 2024.4.3@sha256:71e02388dcd720e2f49538046f81bb1932e64e7680c73230fae1b2ace7400805
#     podAnnotations:
#       k8s.v1.cni.cncf.io/networks: "hass-homekit-static"
#     env:
#       TZ: "${TZ}"
#       PYTHONUSERBASE: /config/deps
#     service:
#       main:
#         ports:
#           http:
#             port: 8123
#     persistence:
#       config:
#         enabled: true
#         existingClaim: home-assistant-config-v1
#     ingress:
#       main:
#         annotations:
#           cert-manager.io/cluster-issuer: "letsencrypt-production"
#           hajimari.io/icon: "home-assistant"
#         enabled: true
#         ingressClassName: nginx
#         hosts:
#           - host: &host "hass.${SECRET_DOMAIN}"
#             paths:
#               - path: /
#                 pathType: Prefix
#         tls:
#           - secretName: hass-tls
#             hosts:
#               - *host
#     probes:
#       liveness:
#         enabled: false
#       readiness:
#         enabled: false
#       startup:
#         enabled: false
#     podSecurityContext:
#       runAsUser: 568
#       runAsGroup: 568
#       fsGroup: 568
#       fsGroupChangePolicy: "OnRootMismatch"
#       supplementalGroups:
#         - 100
#     addons:
#       codeserver:
#         enabled: true
#         image:
#           repository: codercom/code-server
#           tag: 4.23.1
#         workingDir: "/config"
#         git:
#           deployKeySecret: home-assistant-code-server-secret
#         args:
#           - --user-data-dir
#           - "/config/.vscode"
#           - --auth
#           - "none"
#         ingress:
#           enabled: true
#           ingressClassName: nginx
#           annotations:
#             cert-manager.io/cluster-issuer: "letsencrypt-production"
#             hajimari.io/icon: mdi:code-greater-than
#           hosts:
#             - host: &host hass-vscode.${SECRET_DOMAIN}
#               paths:
#                 - path: /
#                   pathType: Prefix
#           tls:
#             - secretName: hass-vscode-tls
#               hosts:
#                 - *host
#         resources:
#           requests:
#             cpu: 10m
#             memory: 94M
#           limits:
#             memory: 412M
#         volumeMounts:
#           - name: config
#             mountPath: /config
#     resources:
#       requests:
#         cpu: 34m
#         memory: 351M
#       limits:
#         memory: 660M

